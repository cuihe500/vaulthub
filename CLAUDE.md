# VaultHub 章程

## 项目元数据（不可更改）

**作者**：Changhe Cui
**邮箱**：admin@thankseveryone.top
**代码库**：https://github.com/cuihe500/vaulthub
**许可证**：Apache 2.0

VaultHub 是一个密钥管理系统，旨在安全地存储、管理和轮换加密密钥、API 密钥及其他敏感凭证。

## 技术栈

- **Go**: 1.25.1
- **Web 框架**: Gin
- **ORM**: GORM
- **数据库**: MariaDB/MySQL
- **配置管理**: Viper (TOML格式)
- **CLI**: Cobra
- **权限控制**: Casbin
- **认证**: JWT (golang-jwt/jwt/v5)
- **缓存**: Redis (go-redis/v9)
- **日志**: Zap
- **接口文档**: Swagger

## 项目结构

```
vaulthub/
├── cmd/
│   └── vaulthub/          # 应用程序入口
│       └── main.go        # 主程序
├── internal/              # 私有应用代码
│   ├── api/
│   │   ├── handlers/      # HTTP 请求处理器
│   │   ├── middleware/    # 中间件
│   │   └── routes/        # 路由定义
│   ├── app/               # 应用管理器
│   ├── config/            # 配置管理
│   ├── database/          # 数据库连接和操作
│   │   ├── migrations/    # 数据库迁移
│   │   └── models/        # 数据模型
│   └── service/           # 业务逻辑层
├── pkg/                   # 可公开使用的库代码
│   ├── crypto/            # 加密工具
│   ├── errors/            # 统一错误处理
│   ├── jwt/               # JWT工具
│   ├── logger/            # 日志工具
│   ├── redis/             # Redis工具
│   ├── response/          # 统一响应格式
│   └── version/           # 版本信息
├── configs/               # 配置文件
│   ├── config.toml        # 主配置文件
│   ├── rbac_model.conf    # Casbin权限模型
│   └── .env.example       # 环境变量示例
├── build/                 # 构建输出目录
├── docs/                  # 文档
│   └── swagger/           # Swagger接口文档
├── scripts/               # 构建和部署脚本
├── web/                   # 前端资源
├── go.mod                 # Go 模块定义
└── go.sum                 # 依赖校验

```

## 设计原则

### 1. 简洁至上
- 单一职责：每个包、每个函数只做一件事
- 避免过度抽象：不为"可能的需求"写代码
- 控制嵌套深度：函数不超过3层缩进

### 2. 清晰的分层架构
```
HTTP请求 → 路由 → 处理器 → 服务层 → 数据访问层 → 数据库
```
- **handlers**: 只负责 HTTP 协议相关（请求解析、响应格式）
- **service**: 核心业务逻辑，与 HTTP 无关
- **models/database**: 数据持久化，只关心数据

### 3. 安全第一
- 所有敏感数据加密存储
- 输入验证在处理器层完成
- 防止常见漏洞：SQL 注入、XSS、CSRF

### 4. 可测试性
- 业务逻辑与框架解耦
- 依赖注入优于全局变量
- 单元测试覆盖核心逻辑

## 编码规范

### 命名
- 包名：小写，单个单词
- 接口：简洁有力（如 `Reader`, `Writer`）
- 函数/变量：驼峰命名，见名知义
- 常量：大写+下划线或驼峰
- 日志、注释：中文优先且作为一等公民支持

### 错误处理
```go
// Bad: 吞掉错误
_ = doSomething()

// Good: 明确处理
if err := doSomething(); err != nil {
    return fmt.Errorf("do something failed: %w", err)
}
```

### 数据库操作
- 使用 GORM 的类型安全 API
- 避免原始 SQL（除非性能关键路径）
- 事务要有明确的边界

## 开发工作流

1. **新功能开发**
   - 从数据模型开始（`internal/database/models/`）
   - 实现业务逻辑（`internal/service/`）
   - 添加 HTTP 接口（`internal/api/handlers/`）
   - 注册路由（`internal/api/routes/`）

2. **代码审查标准**
   - 是否有不必要的复杂度？
   - 错误处理是否完整？
   - 是否有安全隐患？
   - 能否用更少的代码实现？

## 注意（必须遵守）
1. 所有的构建均放在build/文件夹内。
2. 所有接口编写完毕后，必须完成详细的swagger接口文档/
3. 不要添加任何非文字内容（如emoji、各种非ASCII符号）在日志、注释、文档等。
4. 在做完任何测试之后，需要删除所有测试文件，保证工作空间干净整洁。
5. 不要编写任何不必要的文档，除非显式指明。
6. 所有接口的必须使用200 HTTP状态码，所有接口的返回必须使用Base类型封装，错误状态码放置在Base类型的Code内。
7. 维护数个枚举（如错误状态码（用于返回值等）、错误类型（用于日志等）），任何错误都必须先补充枚举，所有错误类型都必须从枚举中取值。
8. 所有时区都使用Asia/Shanghai。
9. 所有错误均需要使用统一的errors来处理。
10. 需要编写简要、无歧义的注释，所有注释均使用中文编写。
11. 所有日志必须使用内部封装的日志接口，禁止随意打印，禁止使用fmt打印（特殊情况除外，需添加注释说明）。
12. 对于任何的并发（多线程、goroutine），必须正确显式关闭，并且加入注释说明。
13. 对于任何可能的竞争关系，必须加入锁机制，同时以注释的形式说明锁机制的意义。
14. 添加、删除任何实体类或者变更需要关联数据库变更，必须先创建幂等的up/down的sql文件到internal/database/migrations内。
15. 各类连接（如数据库连接、Redis连接等）必须从Manager中取出，禁止随意创建，若不存在，则必须在应用启动的时候创建连接，特殊情况请加注释说明。
16. 对于一般新增接口，均需要权限认证。若无需权限认证，则需要添加注释说明。
17. 权限验证必须基于现有的权限规则，禁止私自增加、修改、删除权限规则，若需要请询问并明确拿到肯定回复才可以，并且要添加注释说明。
18. 在命令执行的时候，先检索Makefile内的指令，若有可以替代的，优先使用Makefile内的指令而不是原生命令。
19. 在任何注释中不要提及CLAUDE.md文档的存在，该文档默认是对其他用户不可见的。